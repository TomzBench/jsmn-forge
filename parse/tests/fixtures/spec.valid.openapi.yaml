# Minimal OpenAPI 3.1 fixture for testing x-jsmn-forge-as discovery.
#
# Every x-jsmn-forge-as declaration is annotated with the scenarios it covers.
# Schemas adhere to C constraints (maxLength on strings, maxItems on arrays).
#
# Coverage matrix (11 extensions, 20+ scenarios):
#
#   OpenAPI locations:
#     L1  components/schemas           → sensor_reading
#     L2  requestBody/content/schema   → cmd_flag (via prefixItems)
#     L3  responses/content/schema     → device_page (via allOf)
#     L4  parameters[]/schema          → filter_param
#     L5  responses/headers/schema     → req_id
#
#   JSON Schema nesting (deep walk through non-extension parents):
#     N1  properties                   → sample_val (2 levels deep)
#     N2  items                        → sample_item
#     N3  prefixItems                  → cmd_flag
#     N4  allOf branch                 → device_page
#     N5  oneOf branch                 → variant_str, var_b_variant
#     N6  anyOf branch                 → status_code
#     N7  multi-level depth            → sample_val (obj→obj→number)
#                                        status_code (obj→allOf→obj→anyOf→int)
#
#   Primitive types with extension:
#     P1  object                       → sensor_reading, device_page, var_b_variant
#     P2  integer                      → sample_item, status_code
#     P3  number                       → sample_val
#     P4  boolean                      → cmd_flag
#     P5  string                       → filter_param, variant_str
#     P6  array (ext on array itself)  → sample_list
#
#   Interpolation:
#     I1  ${id}                        → sensor_reading
#     I2  literal                      → filter_param, sample_val, etc.
#     I3  prefix_${id}                 → var_b_variant
#
#   Additional scenarios:
#     X1  non-extension component schema with nested extensions → variant
#     X2  non-extension response body requiring deep walk
#     X3  non-extension requestBody requiring deep walk
#     X4  extension on array type (not just its items) → sample_list
#     X5  extension on items inside an ext-bearing array → sample_item
#     X6  composition chain: allOf → object → properties → anyOf

openapi: "3.1.0"
info:
  title: jsmn-forge discovery fixture
  version: "0.1.0"

paths:
  /devices:
    get:
      operationId: listDevices
      parameters:
        # L4: parameter schema | P5: string | I2: literal
        - name: filter
          in: query
          schema:
            x-jsmn-forge-as: filter_param
            type: string
            maxLength: 32
      responses:
        "200":
          description: Device listing
          headers:
            # L5: response header schema | P5: string
            X-Request-Id:
              schema:
                x-jsmn-forge-as: req_id
                type: string
                maxLength: 36
          content:
            application/json:
              schema:
                # X2: no extension — walker must descend into response body
                type: object
                required:
                  - page
                properties:
                  page:
                    # N4: allOf (no extension on wrapper)
                    allOf:
                      # L3: response body | N4: allOf branch | P1: object | I2: literal
                      - x-jsmn-forge-as: device_page
                        type: object
                        required:
                          - count
                          - status
                        properties:
                          count:
                            type: integer
                            format: uint32
                          status:
                            # N6: anyOf (no extension on wrapper)
                            # X6: composition chain allOf→obj→props→anyOf
                            anyOf:
                              # N6: anyOf branch | P2: integer | N7: multi-level
                              - x-jsmn-forge-as: status_code
                                type: integer
                                format: uint8
    post:
      operationId: sendCommand
      requestBody:
        content:
          application/json:
            schema:
              # X3: no extension — walker must descend into requestBody
              type: array
              maxItems: 1
              # N3: prefixItems (no extension on outer array)
              prefixItems:
                # L2: requestBody | N3: prefixItems | P4: boolean | I2: literal
                - x-jsmn-forge-as: cmd_flag
                  type: boolean
      responses:
        "201":
          description: Accepted

components:
  schemas:
    # L1: components/schemas | P1: object | I1: ${id} interpolation
    sensor_reading:
      x-jsmn-forge-as: "${id}"
      type: object
      required:
        - meta
        - samples
      properties:
        meta:
          # no extension — forces deep walk through non-ext object
          type: object
          required:
            - reading
          properties:
            # N1: properties of non-ext obj | N7: 2+ levels deep | P3: number | I2: literal
            reading:
              x-jsmn-forge-as: sample_val
              type: number
              format: double
        # X4: extension on array type itself | P6: array
        samples:
          x-jsmn-forge-as: sample_list
          type: array
          maxItems: 10
          items:
            # N2: items | X5: inside ext-bearing array | P2: integer
            x-jsmn-forge-as: sample_item
            type: integer
            format: int16

    # X1: no extension on component schema — walker must enter and find nested extensions
    variant:
      # N5: oneOf (no extension on wrapper)
      oneOf:
        # N5: oneOf branch | P5: string | I2: literal
        - x-jsmn-forge-as: variant_str
          type: string
          maxLength: 64
        # N5: oneOf branch | P1: object | I3: prefix_${id} interpolation
        - x-jsmn-forge-as: "var_b_${id}"
          type: object
          required:
            - code
          properties:
            code:
              type: integer
              format: uint16
